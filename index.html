<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Inspector Sigma Core 1.0</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- PapaParse -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Pretendard:wght@400;600;700&display=swap');
        
        [v-cloak] { display: none; }

        :root {
            color-scheme: dark;
        }

        body { 
            font-family: 'Pretendard', sans-serif; 
            background-color: #000000;
            color: #ffffff;
            -webkit-tap-highlight-color: transparent;
        }

        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        
        .glass-panel {
            background: rgba(15, 15, 15, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .cyber-card {
            background: #0a0a0a;
            border: 1px solid #1a1a1a;
            position: relative;
            overflow: hidden;
        }

        .cyber-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 2px;
            height: 100%;
            background: #3b82f6;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .cyber-card:hover::before {
            opacity: 1;
        }

        .status-box {
            background: rgba(20, 20, 20, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }

        .scanline {
            width: 100%;
            height: 2px;
            background: rgba(59, 130, 246, 0.1);
            position: absolute;
            top: 0;
            left: 0;
            z-index: 100;
            pointer-events: none;
            animation: scanline 6s linear infinite;
        }

        @keyframes scanline {
            0% { top: 0; }
            100% { top: 100%; }
        }

        .tab-active {
            color: #3b82f6;
            border-bottom: 2px solid #3b82f6;
        }

        /* 폰트 크기 조절용 */
        .text-base-custom { font-size: var(--base-font-size, 14px); }
        .text-title-custom { font-size: var(--title-font-size, 18px); }
    </style>
</head>
<body class="selection:bg-blue-500/30">
    <div id="app" v-cloak class="max-w-4xl mx-auto min-h-screen flex flex-col pb-20" :style="{'--base-font-size': fontSize + 'px', '--title-font-size': (parseInt(fontSize) + 4) + 'px'}">
        <div class="scanline"></div>

        <!-- 상단 헤더 섹션 -->
        <header class="p-6 md:p-10 flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
            <div>
                <h1 class="text-4xl md:text-5xl font-orbitron font-bold tracking-tighter flex items-center gap-3">
                    <span class="text-white">SIGMA</span>
                    <span class="text-blue-500">CORE</span>
                    <span class="text-white">1.0</span>
                </h1>
                <p class="text-xs md:text-sm font-orbitron text-gray-500 mt-2 tracking-widest uppercase">
                    Though the world be false, I will remain true to myself
                </p>
            </div>

            <div class="flex gap-4 w-full md:w-auto">
                <div class="status-box flex-1 md:w-32 p-3 text-center">
                    <p class="text-[10px] text-gray-500 uppercase font-orbitron mb-1">INDEXED NODES</p>
                    <p class="text-2xl font-bold text-blue-500">{{ displayCount }}</p>
                </div>
                <div class="status-box flex-1 md:w-32 p-3 text-center">
                    <p class="text-[10px] text-gray-500 uppercase font-orbitron mb-1">SYNC INTEGRITY</p>
                    <p class="text-2xl font-bold text-green-500">100%</p>
                </div>
            </div>
        </header>

        <!-- 탭 네비게이션 -->
        <nav class="px-6 md:px-10 border-b border-white/5 flex gap-6 mb-8 overflow-x-auto hide-scrollbar scroll-smooth">
            <button v-for="tab in tabs" :key="tab.id"
                @click="currentTab = tab.id"
                :class="['pb-4 text-[11px] font-orbitron uppercase tracking-widest transition-colors relative whitespace-nowrap', 
                         currentTab === tab.id ? 'text-blue-500' : 'text-gray-500 hover:text-gray-300']">
                {{ tab.name }}
                <div v-if="currentTab === tab.id" class="absolute bottom-0 left-0 w-full h-[2px] bg-blue-500 shadow-[0_0_8px_rgba(59,130,246,0.6)]"></div>
            </button>
        </nav>

        <!-- 검색 및 필터 섹션 -->
        <div v-if="isDataTab && !loading" class="px-6 md:px-10 mb-8">
            <div class="status-box p-4 md:p-6 flex flex-col lg:flex-row gap-4 items-center">
                <!-- 커스텀 검색창 -->
                <div class="relative flex-1 w-full">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-blue-500 font-orbitron">>_</span>
                    <input type="text" v-model="searchQuery" 
                        placeholder="시스템 쿼리 입력 (인물, 지명, 조약, 사건...)" 
                        class="w-full bg-black/40 border border-white/10 rounded-xl py-3 pl-12 pr-4 text-sm focus:outline-none focus:border-blue-500/50 focus:ring-1 focus:ring-blue-500/20 transition-all">
                </div>
                
                <!-- 필터 셀렉트 -->
                <div class="flex gap-3 w-full lg:w-auto">
                    <div class="relative flex-1 lg:w-40">
                        <select v-model="selectedEra" class="w-full bg-black/40 border border-white/10 rounded-xl py-3 px-4 text-xs appearance-none focus:outline-none focus:border-blue-500/50">
                            <option value="전체">전 시대 (All Eras)</option>
                            <option v-for="era in uniqueEras" :key="era" :value="era">{{ era }}</option>
                        </select>
                    </div>
                    <div class="relative flex-1 lg:w-40">
                        <select v-model="selectedCategory" class="w-full bg-black/40 border border-white/10 rounded-xl py-3 px-4 text-xs appearance-none focus:outline-none focus:border-blue-500/50">
                            <option value="전체">전 분류 (Categories)</option>
                            <option v-for="cat in uniqueCategories" :key="cat" :value="cat">{{ cat }}</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- 콘텐츠 로딩 상태 -->
        <main v-if="loading" class="px-6 md:px-10 py-20 text-center">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500 mx-auto mb-4"></div>
            <p class="text-gray-500 font-orbitron text-xs tracking-widest uppercase">Synchronizing Nodes...</p>
        </main>

        <!-- 한국사 탭 콘텐츠 -->
        <main v-else-if="isDataTab" class="px-6 md:px-10 grid grid-cols-1 md:grid-cols-2 gap-6">
            <div v-for="(item, idx) in sortedFilteredList" :key="item.id" 
                @click="incrementViewCount(item)"
                class="cyber-card group p-6 rounded-2xl flex flex-col justify-between min-h-[220px] cursor-pointer">
                
                <div>
                    <!-- 카드 헤더 -->
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex flex-col gap-1">
                            <span class="text-[10px] uppercase tracking-tighter text-gray-500 font-medium">
                                {{ item.시대 }} | {{ item.세부 }}
                            </span>
                            <h2 class="font-bold group-hover:text-blue-400 transition-colors text-title-custom">{{ item.제목 }}</h2>
                        </div>
                        <div class="flex flex-col items-end gap-1">
                            <span class="text-[10px] font-orbitron text-blue-500 uppercase tracking-widest">{{ item.분류 }}</span>
                            <span v-if="getViewCount(item.id) > 0" class="text-[9px] font-orbitron text-green-500/60">ACCESS: {{ getViewCount(item.id) }}</span>
                        </div>
                    </div>

                    <!-- 태그 영역 -->
                    <div class="flex flex-wrap gap-2 mt-4">
                        <span v-for="(tag, tIdx) in splitContent(item.내용)" :key="tIdx"
                            class="px-3 py-1 bg-blue-500/5 border border-blue-500/20 rounded font-medium text-base-custom text-blue-400">
                            #{{ tag.trim() }}
                        </span>
                    </div>
                </div>

                <!-- 카드 푸터 -->
                <div class="mt-8 pt-4 border-t border-white/5 flex justify-between items-center opacity-40 group-hover:opacity-100 transition-opacity">
                    <div class="flex items-center gap-2">
                        <svg class="w-3 h-3 text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                        </svg>
                        <span class="text-[9px] font-orbitron uppercase tracking-widest">ENCRYPTED NODE</span>
                    </div>
                    <span class="text-[9px] font-orbitron uppercase tracking-widest text-gray-500">NODE VERIFIED</span>
                </div>
            </div>

            <!-- 결과 없음 -->
            <div v-if="filteredList.length === 0" class="col-span-full py-20 text-center border border-dashed border-white/10 rounded-2xl">
                <p class="text-gray-500 font-orbitron uppercase tracking-widest">No matching nodes found in the system.</p>
                <button @click="resetFilters" class="mt-4 text-blue-500 text-xs font-orbitron uppercase tracking-widest border border-blue-500/30 px-4 py-2 rounded-full hover:bg-blue-500/10 transition-colors">
                    Reset Query
                </button>
            </div>
        </main>

        <!-- 설정 탭 -->
        <main v-else-if="currentTab === 'settings'" class="px-6 md:px-10">
            <div class="cyber-card p-8 rounded-2xl">
                <h3 class="text-xl font-orbitron text-blue-500 mb-6 uppercase tracking-widest">System Configuration</h3>
                
                <div class="space-y-8">
                    <!-- 폰트 크기 조절 -->
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <label class="text-sm font-orbitron text-gray-400 uppercase tracking-wider">Font Scaling</label>
                            <span class="text-blue-500 font-orbitron">{{ fontSize }}px</span>
                        </div>
                        <input type="range" v-model="fontSize" min="12" max="24" step="1"
                            class="w-full h-1 bg-gray-800 rounded-lg appearance-none cursor-pointer accent-blue-500">
                        <div class="flex justify-between text-[10px] text-gray-600 font-orbitron">
                            <span>MIN (12PX)</span>
                            <span>MAX (24PX)</span>
                        </div>
                    </div>

                    <!-- 통계 초기화 -->
                    <div class="pt-6 border-t border-white/5">
                        <label class="text-sm font-orbitron text-gray-400 uppercase tracking-wider mb-4 block">Data Management</label>
                        <button @click="clearStats" class="px-4 py-2 border border-red-500/30 text-red-500 text-xs font-orbitron uppercase tracking-widest rounded hover:bg-red-500/10 transition-all">
                            Clear Access Logs
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- 다른 탭 placeholder -->
        <main v-else class="px-6 md:px-10 py-20 text-center">
            <div class="status-box p-10 border-dashed border-white/10">
                <h3 class="text-xl font-orbitron text-gray-600 mb-2">ACCESS RESTRICTED</h3>
                <p class="text-xs text-gray-700 font-orbitron tracking-widest uppercase">This sector is currently under construction or encrypted.</p>
                <div class="mt-8 flex justify-center gap-2">
                    <div class="w-1 h-1 bg-blue-500 animate-pulse"></div>
                    <div class="w-1 h-1 bg-blue-500 animate-pulse delay-75"></div>
                    <div class="w-1 h-1 bg-blue-500 animate-pulse delay-150"></div>
                </div>
            </div>
        </main>

        <!-- 하단 플로팅 버튼 -->
        <button @click="scrollToTop" 
            class="fixed bottom-8 right-8 w-14 h-14 glass-panel text-blue-500 rounded-xl flex items-center justify-center hover:bg-blue-500 hover:text-white transition-all active:scale-90 z-50 shadow-[0_0_20px_rgba(59,130,246,0.2)]"
            v-show="showScrollTop">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 11l7-7m0 0l7 7m-7-7v18" />
            </svg>
        </button>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, onUnmounted, watch } = Vue;

        createApp({
            setup() {
                const items = ref([]);
                const loading = ref(true);
                const searchQuery = ref('');
                const selectedEra = ref('전체');
                const selectedCategory = ref('전체');
                const showScrollTop = ref(false);
                const currentTab = ref('korean_history');
                
                // 로컬 스토리지 데이터 안전하게 가져오기
                const savedFontSize = localStorage.getItem('sigma-font-size');
                const fontSize = ref(savedFontSize ? parseInt(savedFontSize) : 14);
                
                const currentFont = ref(localStorage.getItem('sigma-font-family') || 'Pretendard');

                const fontOptions = [
                    { name: '프리텐다드', value: 'Pretendard' },
                    { name: '노토산스', value: 'Noto Sans KR' },
                    { name: '나눔고딕', value: 'Nanum Gothic' },
                    { name: '나눔명조', value: 'Nanum Myeongjo' },
                    { name: '감자꽃', value: 'Gamja Flower' }
                ];

                let initialCounts = {};
                try {
                    const savedCounts = localStorage.getItem('sigma-view-counts');
                    if (savedCounts) initialCounts = JSON.parse(savedCounts);
                } catch (e) {
                    console.error('Error loading view counts:', e);
                }
                const viewCounts = ref(initialCounts);

                const tabs = ref([
                    { id: 'korean_history', name: '한국사' },
                    { id: 'criminal_law_general', name: '형법 총론' },
                    { id: 'criminal_law_special', name: '형법 각론' },
                    { id: 'criminal_procedure', name: '형사소송법' },
                    { id: 'constitutional_law', name: '헌법' },
                    { id: 'info_security', name: '정보보호론' },
                    { id: 'network_security', name: '네트워크보안' },
                    { id: 'software_engineering', name: '소프트웨어공학' },
                    { id: 'settings', name: '설정' }
                ]);

                const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQE3ia0nwvZ99-e5SF707qTXOq1Vttc8urdPis0KiL7pHfduNdFawGElyYum3wrtl3yzHMdtSw5erix/pub?output=csv';

                const fetchData = async () => {
                    loading.value = true;
                    try {
                        const response = await fetch(csvUrl + '&t=' + new Date().getTime());
                        const csvText = await response.text();
                        Papa.parse(csvText, {
                            header: true,
                            skipEmptyLines: true,
                            complete: (results) => {
                                // id가 없는 데이터에 고유 id 부여
                                items.value = results.data
                                    .filter(row => row['제목'])
                                    .map((row, index) => ({
                                        ...row,
                                        id: row['제목'] + '_' + row['시대'] + '_' + index
                                    }));
                                loading.value = false;
                            }
                        });
                    } catch (err) {
                        console.error('Data sync failed:', err);
                        loading.value = false;
                    }
                };

                const uniqueEras = computed(() => [...new Set(items.value.map(i => i['시대']))].filter(Boolean));
                const uniqueCategories = computed(() => [...new Set(items.value.map(i => i['분류']))].filter(Boolean));

                const isDataTab = computed(() => currentTab.value === 'korean_history');

                const displayCount = computed(() => {
                    // 로딩 중이거나 한국사 탭이 아닐 때만 0으로 표시
                    if (loading.value) return 0;
                    if (currentTab.value !== 'korean_history') return 0;
                    return sortedFilteredList.value.length;
                });

                const sortedFilteredList = computed(() => {
                    if (!items.value || items.value.length === 0) return [];
                    
                    const filtered = items.value.filter(item => {
                        const s = searchQuery.value.toLowerCase();
                        const searchableText = `${item['시대']} ${item['세부']} ${item['분류']} ${item['제목']} ${item['내용']}`.toLowerCase();
                        const matchSearch = searchableText.includes(s);
                        const matchEra = selectedEra.value === '전체' || item['시대'] === selectedEra.value;
                        const matchCat = selectedCategory.value === '전체' || item['분류'] === selectedCategory.value;
                        return matchSearch && matchEra && matchCat;
                    });

                    // 터치 횟수(조회수) 순으로 내림차순 정렬
                    return filtered.sort((a, b) => {
                        const countA = viewCounts.value[a.id] || 0;
                        const countB = viewCounts.value[b.id] || 0;
                        return countB - countA;
                    });
                });

                const incrementViewCount = (item) => {
                    const currentCount = viewCounts.value[item.id] || 0;
                    viewCounts.value[item.id] = currentCount + 1;
                    localStorage.setItem('sigma-view-counts', JSON.stringify(viewCounts.value));
                };

                const getViewCount = (id) => viewCounts.value[id] || 0;

                const clearStats = () => {
                    if (confirm('모든 접속 로그(터치 횟수)를 초기화하시겠습니까?')) {
                        viewCounts.value = {};
                        localStorage.removeItem('sigma-view-counts');
                    }
                };

                const splitContent = (content) => content ? content.split('/') : [];
                const resetFilters = () => { searchQuery.value = ''; selectedEra.value = '전체'; selectedCategory.value = '전체'; };
                const scrollToTop = () => window.scrollTo({ top: 0, behavior: 'smooth' });
                const handleScroll = () => showScrollTop.value = window.scrollY > 300;

                watch(fontSize, (newVal) => {
                    localStorage.setItem('sigma-font-size', newVal);
                });

                watch(currentFont, (newVal) => {
                    localStorage.setItem('sigma-font-family', newVal);
                });

                onMounted(() => { fetchData(); window.addEventListener('scroll', handleScroll); });
                onUnmounted(() => window.removeEventListener('scroll', handleScroll));

                return {
                    items, loading, searchQuery, selectedEra, selectedCategory,
                    uniqueEras, uniqueCategories, sortedFilteredList, resetFilters,
                    showScrollTop, scrollToTop, splitContent, currentTab, tabs,
                    fontSize, viewCounts, incrementViewCount, getViewCount, clearStats, isDataTab,
                    displayCount, fontOptions, currentFont
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
